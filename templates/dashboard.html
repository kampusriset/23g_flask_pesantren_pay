{% extends 'base.html' %} {% block title %}Dashboard - PonPay{% endblock %}
{% block extra_css %}
<style>
  .top-ticker {
    position: static;
  }
</style>
{% endblock %}
{% block page_title %}Dashboard{% endblock %} {% block content %}
<div class="container-fluid">
  <!-- Top Ticker: Pemasukan / Pengeluaran / Saldo -->

  <div class="top-ticker mb-4" aria-hidden="false">
    <div class="ticker-viewport">
      <div class="ticker-track">
        <!-- Set 1 -->
        <div class="ticker-item">
          <div class="ticker-icon text-success">
            <img src="{{ url_for('static', filename='images/icon_pemasukan.svg') }}" alt="Pemasukan"
              style="width: 32px; height: 26px;">
          </div>
          <div class="ticker-text">
            <small>Pemasukan</small>
            <strong class="text-success">{{ stats.total_income|rupiah }}</strong>
          </div>
        </div>
        <div class="ticker-item">
          <div class="ticker-icon text-danger">
            <img src="{{ url_for('static', filename='images/icon_pengeluaran.svg') }}" alt="Pengeluaran"
              style="width: 32px; height: 26px;">
          </div>
          <div class="ticker-text">
            <small>Pengeluaran</small>
            <strong class="text-danger">{{ stats.total_expense|rupiah }}</strong>
          </div>
        </div>
        <div class="ticker-item">
          <div class="ticker-icon text-primary">
            <i class="fas fa-wallet"></i>
          </div>
          <div class="ticker-text">
            <small>Saldo Kas</small>
            <strong class="text-primary">{{ stats.balance|rupiah }}</strong>
          </div>
        </div>
        <div class="ticker-item">
          <div class="ticker-icon"
            style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);">
            <i class="fas fa-chart-line"></i>
          </div>
          <div class="ticker-text">
            <small>Net Profit</small>
            <strong style="color: #8b5cf6;">{{ (stats.total_income - stats.total_expense)|rupiah }}</strong>
          </div>
        </div>
        <!-- Set 2 (duplicate for seamless loop) -->
        <div class="ticker-item">
          <div class="ticker-icon text-success">
            <img src="{{ url_for('static', filename='images/icon_pemasukan.svg') }}" alt="Pemasukan"
              style="width: 32px; height: 26px;">
          </div>
          <div class="ticker-text">
            <small>Pemasukan</small>
            <strong class="text-success">{{ stats.total_income|rupiah }}</strong>
          </div>
        </div>
        <div class="ticker-item">
          <div class="ticker-icon text-danger">
            <img src="{{ url_for('static', filename='images/icon_pengeluaran.svg') }}" alt="Pengeluaran"
              style="width: 32px; height: 26px;">
          </div>
          <div class="ticker-text">
            <small>Pengeluaran</small>
            <strong class="text-danger">{{ stats.total_expense|rupiah }}</strong>
          </div>
        </div>
        <div class="ticker-item">
          <div class="ticker-icon text-primary">
            <i class="fas fa-wallet"></i>
          </div>
          <div class="ticker-text">
            <small>Saldo Kas</small>
            <strong class="text-primary">{{ stats.balance|rupiah }}</strong>
          </div>
        </div>
        <div class="ticker-item">
          <div class="ticker-icon"
            style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);">
            <i class="fas fa-chart-line"></i>
          </div>
          <div class="ticker-text">
            <small>Net Profit</small>
            <strong style="color: #8b5cf6;">{{ (stats.total_income - stats.total_expense)|rupiah }}</strong>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Hero Section with Main Balance Card -->
  <div class="hero-section mb-5">
    <div class="row">
      <div class="col-12">
        <div class="balance-card-main">
          <div class="balance-card-glow"></div>
          <div class="balance-card-content">
            <div class="balance-header">
              <div class="balance-info">
                <div class="balance-meta">
                  <span class="balance-badge">Live Balance</span>
                  <p class="balance-label">Saldo Kas Pondok</p>
                </div>
                <h1 class="balance-amount" data-count="{{ stats.balance }}">
                  <span class="currency-symbol">Rp</span>
                  <span class="amount-value">{{ stats.balance|rupiah|replace('Rp ', '') }}</span>
                </h1>
                <p class="balance-subtitle">
                  <i class="fas fa-clock me-1"></i>
                  Update terakhir: {{ stats.last_update if stats.last_update
                  else 'Hari ini' }}
                </p>
              </div>
              <div class="balance-visual">
                <div class="balance-icon-wrapper">
                  <i class="fas fa-wallet balance-icon"></i>
                  <div class="icon-particles">
                    <div class="particle particle-1"></div>
                    <div class="particle particle-2"></div>
                    <div class="particle particle-3"></div>
                  </div>
                </div>
              </div>
            </div>
            <div class="balance-actions">
              <a href="{{ url_for('wallet.index') }}" class="btn btn-primary-ghost">
                <i class="fas fa-eye"></i>
                <span>Lihat Detail</span>
              </a>
              <a href="{{ url_for('transaction.add') }}" class="btn btn-primary-solid">
                <i class="fas fa-plus"></i>
                <span>Tambah Transaksi</span>
              </a>
              <a href="{{ url_for('statistics.index') }}" class="btn btn-secondary-ghost">
                <i class="fas fa-chart-line"></i>
                <span>Analytics</span>
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="stat-card">
        <div class="stat-icon income" style="display: flex; align-items: center; justify-content: center;">
          <img src="{{ url_for('static', filename='images/icon_pemasukan.svg') }}" alt="Pemasukan"
            style="width: 40px; height: 32px;">
        </div>
        <div class="stat-content">
          <p class="stat-label">Total Pemasukan</p>
          <h5 class="stat-value">{{ stats.total_income|rupiah }}</h5>
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="stat-card">
        <div class="stat-icon expense" style="display: flex; align-items: center; justify-content: center;">
          <img src="{{ url_for('static', filename='images/icon_pengeluaran.svg') }}" alt="Pengeluaran"
            style="width: 40px; height: 32px;">
        </div>
        <div class="stat-content">
          <p class="stat-label">Total Pengeluaran</p>
          <h5 class="stat-value">{{ stats.total_expense|rupiah }}</h5>
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="stat-card">
        <div class="stat-icon transaction">
          <i class="fas fa-exchange-alt"></i>
        </div>
        <div class="stat-content">
          <p class="stat-label">Total Transaksi</p>
          <h5 class="stat-value">{{ stats.total_transactions }}</h5>
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="stat-card">
        <div class="stat-icon profit">
          <i class="fas fa-chart-line"></i>
        </div>
        <div class="stat-content">
          <p class="stat-label">Net Profit</p>
          <h5 class="stat-value">
            {{ (stats.total_income - stats.total_expense)|rupiah }}
          </h5>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart Row -->
  <div class="row mb-4">
    <div class="col-lg-8">
      <div class="card card-chart">
        <div class="card-header">
          <h6 class="card-title">
            Grafik Pemasukan & Pengeluaran (12 Bulan Terakhir)
          </h6>
        </div>
        <div class="card-body">
          <canvas id="revenueChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="col-lg-4">
      <div class="card card-actions">
        <div class="card-header">
          <h6 class="card-title"><i class="fas fa-bolt me-2 text-warning"></i>Aksi Cepat</h6>
        </div>
        <div class="card-body quick-actions-body">
          <a href="{{ url_for('transaction.add') }}" class="btn btn-action btn-action-add">
            <div class="action-icon">
              <i class="fas fa-plus"></i>
            </div>
            <div class="action-text">
              <span class="action-title">Tambah Transaksi</span>
              <span class="action-desc">Catat pemasukan/pengeluaran</span>
            </div>
            <i class="fas fa-chevron-right action-arrow"></i>
          </a>
          <a href="{{ url_for('wallet.index') }}" class="btn btn-action btn-action-wallet">
            <div class="action-icon">
              <i class="fas fa-wallet"></i>
            </div>
            <div class="action-text">
              <span class="action-title">Lihat Dompet</span>
              <span class="action-desc">Kelola saldo pondok</span>
            </div>
            <i class="fas fa-chevron-right action-arrow"></i>
          </a>
          <a href="{{ url_for('statistics.index') }}" class="btn btn-action btn-action-stats">
            <div class="action-icon">
              <i class="fas fa-chart-bar"></i>
            </div>
            <div class="action-text">
              <span class="action-title">Lihat Statistik</span>
              <span class="action-desc">Analisis keuangan</span>
            </div>
            <i class="fas fa-chevron-right action-arrow"></i>
          </a>
          <a href="{{ url_for('transaction.index') }}" class="btn btn-action btn-action-list">
            <div class="action-icon">
              <i class="fas fa-list"></i>
            </div>
            <div class="action-text">
              <span class="action-title">Semua Transaksi</span>
              <span class="action-desc">Riwayat lengkap</span>
            </div>
            <i class="fas fa-chevron-right action-arrow"></i>
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Transactions -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h6 class="card-title">Riwayat Transaksi Terakhir</h6>
          <a href="{{ url_for('transaction.index') }}" class="btn btn-sm btn-outline-primary">Lihat Semua</a>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover transaction-table">
              <thead>
                <tr>
                  <th class="table-header-date">Tanggal</th>
                  <th class="table-header-category">Kategori</th>
                  <th class="table-header-description">Keterangan</th>
                  <th class="table-header-amount text-end">Nominal</th>
                  <th class="table-header-type">Jenis</th>
                </tr>
              </thead>
              <tbody>
                {% for trans in stats.recent_transactions %}
                <tr
                  class="transaction-row {% if trans['type'] == 'income' %}income-row{% else %}expense-row{% endif %}">
                  <td class="transaction-date">
                    <div class="date-display">
                      <span class="date-day">{{ (trans['date']|format_date).split()[0] }}</span>
                      <span class="date-month">{{ (trans['date']|format_date).split()[1] }}</span>
                    </div>
                    <small class="date-year text-muted">{{ (trans['date']|format_date).split()[2]
                      }}</small>
                  </td>
                  <td>
                    <span
                      class="badge-modern {% if trans['type'] == 'income' %}badge-income{% else %}badge-expense{% endif %}">
                      <i
                        class="fas {% if trans['type'] == 'income' %}fa-plus-circle{% else %}fa-minus-circle{% endif %} me-1"></i>
                      {{ trans['category'] }}
                    </span>
                  </td>
                  <td class="transaction-description">
                    <div class="description-text">
                      {{ trans['description'] }}
                    </div>
                  </td>
                  <td class="text-end transaction-amount">
                    <div class="amount-wrapper">
                      <span
                        class="amount-value {% if trans['type'] == 'income' %}text-success{% else %}text-danger{% endif %}">
                        {% if trans['type'] == 'income' %}
                        <i class="fas fa-arrow-up me-1"></i>
                        {% else %}
                        <i class="fas fa-arrow-down me-1"></i>
                        {% endif %} {{ trans['amount']|rupiah }}
                      </span>
                    </div>
                  </td>
                  <td>
                    <span
                      class="transaction-type {% if trans['type'] == 'income' %}type-income{% else %}type-expense{% endif %}">
                      {% if trans['type'] == 'income' %}
                      <img src="{{ url_for('static', filename='images/icon_pemasukan.svg') }}" alt="Pemasukan"
                        style="width: 20px; height: 16px; margin-right: 4px;">Pemasukan {%
                      else %}
                      <img src="{{ url_for('static', filename='images/icon_pengeluaran.svg') }}" alt="Pengeluaran"
                        style="width: 20px; height: 16px; margin-right: 4px;">Pengeluaran {%
                      endif %}
                    </span>
                  </td>
                </tr>
                {% else %}
                <tr class="empty-state">
                  <td colspan="5" class="text-center py-5">
                    <div class="empty-state-content">
                      <i class="fas fa-receipt fa-3x text-muted mb-3"></i>
                      <h6 class="text-muted">Belum ada transaksi</h6>
                      <p class="text-muted small">
                        Transaksi pertama Anda akan muncul di sini
                      </p>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart Data as JSON -->
<script id="chartData" type="application/json">
{
  "months": {{ months|safe }},
  "income": {{ income_data|safe }},
  "expense": {{ expense_data|safe }}
}
</script>

<script>
  // Count-up animation for balance
  function animateValue(obj, start, end, duration) {
    let startTimestamp = null;
    const step = (timestamp) => {
      if (!startTimestamp) startTimestamp = timestamp;
      const progress = Math.min((timestamp - startTimestamp) / duration, 1);
      obj.innerHTML = 'Rp ' + Math.floor(progress * (end - start) + start).toLocaleString('id-ID');
      if (progress < 1) {
        window.requestAnimationFrame(step);
      }
    };
    window.requestAnimationFrame(step);
  }

  // Initialize count-up animation when page loads
  document.addEventListener('DOMContentLoaded', function () {
    const balanceElement = document.querySelector('.balance-amount');
    if (balanceElement && balanceElement.dataset.count) {
      const targetValue = parseInt(balanceElement.dataset.count);
      animateValue(balanceElement, 0, targetValue, 2000);
    }
  });

  // Chart Logic with Dynamic Theme Support
  (function () {
    // Parse chart data from JSON script
    let chartData = { months: [], income: [], expense: [] };
    try {
      const dataEl = document.getElementById('chartData');
      if (dataEl) {
        chartData = JSON.parse(dataEl.textContent);
      }
    } catch (e) {
      console.error('Failed to parse chart data:', e);
    }

    const months = chartData.months;
    const incomeData = chartData.income;
    const expenseData = chartData.expense;
    let revenueChart = null;

    function initChart(isDark) {
      const ctxCanvas = document.getElementById('revenueChart');
      if (!ctxCanvas) return;
      const ctx = ctxCanvas.getContext('2d');

      // Premium Dark Mode Theme Colors
      const gridColor = isDark ? 'rgba(255, 255, 255, 0.04)' : 'rgba(45, 80, 22, 0.08)';
      const textColor = isDark ? '#9ca3af' : '#6b7280';
      const tooltipBg = isDark ? '#1e293b' : 'rgba(255, 255, 255, 0.95)';
      const tooltipText = isDark ? '#e5e7eb' : '#1a1a1a';
      const tooltipBorder = isDark ? 'rgba(255, 255, 255, 0.12)' : 'rgba(45, 80, 22, 0.2)';

      if (revenueChart) {
        revenueChart.destroy();
      }

      revenueChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: months,
          datasets: [
            {
              label: 'Pemasukan',
              data: incomeData,
              borderColor: '#22c55e',
              backgroundColor: 'rgba(34, 197, 94, 0.15)',
              borderWidth: 3,
              tension: 0.4,
              fill: true,
              pointBackgroundColor: '#22c55e',
              pointBorderColor: isDark ? '#1e293b' : '#fff',
              pointBorderWidth: 3,
              pointRadius: 6,
              pointHoverRadius: 8,
              pointHoverBackgroundColor: '#16a34a',
              pointHoverBorderColor: isDark ? '#1e293b' : '#fff',
              pointHoverBorderWidth: 3,
              hoverBorderWidth: 4
            },
            {
              label: 'Pengeluaran',
              data: expenseData,
              borderColor: '#ef4444',
              backgroundColor: 'rgba(239, 68, 68, 0.15)',
              borderWidth: 3,
              tension: 0.4,
              fill: true,
              pointBackgroundColor: '#ef4444',
              pointBorderColor: isDark ? '#1e293b' : '#fff',
              pointBorderWidth: 3,
              pointRadius: 6,
              pointHoverRadius: 8,
              pointHoverBackgroundColor: '#dc2626',
              pointHoverBorderColor: isDark ? '#1e293b' : '#fff',
              pointHoverBorderWidth: 3,
              hoverBorderWidth: 4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: {
                usePointStyle: true,
                padding: 20,
                font: {
                  size: 13,
                  weight: '600',
                  family: 'Inter, sans-serif'
                },
                color: textColor
              }
            },
            tooltip: {
              enabled: true,
              backgroundColor: tooltipBg,
              titleColor: tooltipText,
              bodyColor: tooltipText,
              borderColor: tooltipBorder,
              borderWidth: 1,
              cornerRadius: 8,
              displayColors: true,
              padding: 12,
              titleFont: {
                size: 14,
                weight: 'bold',
                family: 'Inter, sans-serif'
              },
              bodyFont: {
                size: 13,
                family: 'Inter, sans-serif'
              },
              callbacks: {
                title: function (context) {
                  return 'Bulan: ' + context[0].label;
                },
                label: function (context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  label += 'Rp ' + context.parsed.y.toLocaleString('id-ID');
                  return label;
                },
                afterLabel: function (context) {
                  if (context.datasetIndex === 0) {
                    return 'Pemasukan bulan ini';
                  } else {
                    return 'Pengeluaran bulan ini';
                  }
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function (value) {
                  return 'Rp ' + (value / 1000000).toFixed(1) + 'M';
                },
                font: {
                  size: 12,
                  weight: '500',
                  family: 'Inter, sans-serif'
                },
                color: textColor
              },
              grid: {
                color: gridColor,
                lineWidth: 1,
                drawBorder: false
              },
              border: {
                display: false
              }
            },
            x: {
              ticks: {
                font: {
                  size: 12,
                  weight: '500',
                  family: 'Inter, sans-serif'
                },
                color: textColor
              },
              grid: {
                color: gridColor,
                lineWidth: 1,
                drawBorder: false
              },
              border: {
                display: false
              }
            }
          },
          interaction: {
            intersect: false,
            mode: 'index'
          },
          hover: {
            mode: 'index',
            intersect: false
          },
          animation: {
            duration: 800,
            easing: 'easeOutQuart'
          }
        }
      });
    }

    // Initial Load
    document.addEventListener('DOMContentLoaded', () => {
      // Initial load
      const initialIsDark = document.documentElement.getAttribute('data-theme') === 'dark';
      initChart(initialIsDark);

      // Listen for theme changes
      document.addEventListener('themeChanged', function (e) {
        initChart(e.detail.isDark);
      });
    });
  })();
</script>
{% endblock %}