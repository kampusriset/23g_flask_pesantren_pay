{% extends "base.html" %}

{% block title %}Data Santri - PonPay{% endblock %}

{% block page_title %}
<div class="d-flex justify-content-between align-items-center">
    <div>
        <h1 class="page-title"><i class="fas fa-users"></i> Daftar Santri</h1>
        <p class="text-muted">Total: {{ students|length }} Santri</p>
    </div>
    <div class="btn-group" role="group">
        <a href="{{ url_for('students.add') }}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Tambah Santri
        </a>
        <a href="{{ url_for('students.import_excel') }}" class="btn btn-info">
            <i class="fas fa-upload"></i> Import Excel
        </a>
        <a href="{{ url_for('students.export_excel') }}" class="btn btn-success">
            <i class="fas fa-download"></i> Export Data
        </a>
        <a href="{{ url_for('students.download_report') }}" class="btn btn-warning">
            <i class="fas fa-file-excel"></i> Laporan
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card" style="border-left: 5px solid #6366F1;">
                <div class="card-body">
                    <h6 class="card-title text-muted">Total Santri</h6>
                    <h3 style="color: #6366F1; font-weight: bold;">{{ students|length }}</h3>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card" style="border-left: 5px solid #10B981;">
                <div class="card-body">
                    <h6 class="card-title text-muted">Santri Aktif</h6>
                    <h3 style="color: #10B981; font-weight: bold;">
                        {% set aktif = students|selectattr('status', 'equalto', 'aktif')|list %}
                        {{ aktif|length }}
                    </h3>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card" style="border-left: 5px solid #F59E0B;">
                <div class="card-body">
                    <h6 class="card-title text-muted">Belum Bayar Bulan Ini</h6>
                    <h3 style="color: #F59E0B; font-weight: bold;">
                        {% set belum_bayar_count = 0 %}
                        {% for s in students %}
                            {% if s.month_payment == 0 %}
                                {% set belum_bayar_count = belum_bayar_count + 1 %}
                            {% endif %}
                        {% endfor %}
                        {{ belum_bayar_count }}
                    </h3>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card" style="border-left: 5px solid #8B5CF6;">
                <div class="card-body">
                    <h6 class="card-title text-muted">Total Bayar</h6>
                    <h3 style="color: #8B5CF6; font-weight: bold;">
                        {{ (students|map(attribute='total_payment')|sum)|int|rupiah }}
                    </h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter & Tabs -->
    <div class="card mb-4">
        <div class="card-body">
            <ul class="nav nav-tabs mb-3" id="studentTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all-pane" type="button" role="tab">
                        <i class="fas fa-list"></i> Semua Santri
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="belum-bayar-tab" data-bs-toggle="tab" data-bs-target="#belum-bayar-pane" type="button" role="tab">
                        <i class="fas fa-exclamation-circle"></i> Belum Bayar Bulan Ini
                    </button>
                </li>
            </ul>

            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Cari Nama</label>
                    <input type="text" class="form-control" id="search" placeholder="Nama santri...">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Kelas</label>
                    <select class="form-select" id="filterKelas">
                        <option value="">Semua Kelas</option>
                        <option value="Kelas 1">Kelas 1</option>
                        <option value="Kelas 2">Kelas 2</option>
                        <option value="Kelas 3">Kelas 3</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="filterStatus">
                        <option value="">Semua Status</option>
                        <option value="aktif">Aktif</option>
                        <option value="non-aktif">Non-Aktif</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="reset" class="btn btn-outline-secondary w-100" onclick="document.getElementById('search').value=''; document.getElementById('filterKelas').value=''; document.getElementById('filterStatus').value='';">
                        Reset
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Content -->
    <div class="tab-content" id="studentTabsContent">
        <!-- All Students Tab -->
        <div class="tab-pane fade show active" id="all-pane" role="tabpanel" tabindex="0">
            <div class="card">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 5%">No.</th>
                                <th>Nama Santri</th>
                                <th>NISN</th>
                                <th>Kelas</th>
                                <th>Jenis Kelamin</th>
                                <th>Status</th>
                                <th>Total Pembayaran</th>
                                <th style="width: 18%">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="studentTableBody">
                            {% if students %}
                                {% for student in students %}
                                <tr class="student-row" data-name="{{ student.name }}" data-kelas="{{ student.kelas }}" data-status="{{ student.status }}" data-paid="{{ student.month_payment }}">
                                    <td>{{ loop.index }}</td>
                                    <td>
                                        <strong>{{ student.name }}</strong>
                                        <br>
                                        <small class="text-muted">{{ student.parent_name }}</small>
                                    </td>
                                    <td><code>{{ student.nisn }}</code></td>
                                    <td>
                                        <span class="badge" style="background-color: #E0E7FF; color: #4F46E5;">{{ student.kelas }}</span>
                                    </td>
                                    <td>
                                        {% if student.jenis_kelamin == 'Perempuan' %}
                                            <i class="fas fa-venus" style="color: #EC4899;"></i> Perempuan
                                        {% else %}
                                            <i class="fas fa-mars" style="color: #3B82F6;"></i> Laki-laki
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if student.status == 'aktif' %}
                                            <span class="badge" style="background-color: #D1FAE5; color: #065F46;"><i class="fas fa-check-circle"></i> Aktif</span>
                                        {% else %}
                                            <span class="badge" style="background-color: #FEE2E2; color: #7F1D1D;"><i class="fas fa-times-circle"></i> Non-Aktif</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <strong style="color: #6366F1;">{{ student.total_payment|rupiah }}</strong>
                                        <br>
                                        <small class="text-muted">Bulan ini: {{ student.month_payment|rupiah }}</small>
                                    </td>
                                    <td>
                                        <a href="{{ url_for('students.detail', student_id=student.id) }}" class="btn btn-sm btn-outline-primary" title="Lihat">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="{{ url_for('students.edit', student_id=student.id) }}" class="btn btn-sm btn-outline-warning" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{{ url_for('students.delete', student_id=student.id) }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Yakin?')" title="Hapus">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="8" class="text-center text-muted py-4">Tidak ada santri</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Belum Bayar Tab -->
        <div class="tab-pane fade" id="belum-bayar-pane" role="tabpanel" tabindex="0">
            <div class="card">
                {% set belum_bayar_list = [] %}
                {% for student in students %}
                    {% if student.month_payment == 0 %}
                        {% set _ = belum_bayar_list.append(student) %}
                    {% endif %}
                {% endfor %}

                {% if belum_bayar_list|length > 0 %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 5%">No.</th>
                                <th>Nama Santri</th>
                                <th>NISN</th>
                                <th>Kelas</th>
                                <th>Orang Tua</th>
                                <th>No. Telepon</th>
                                <th style="width: 18%">Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for student in belum_bayar_list %}
                            <tr style="background-color: #FFFBEB;">
                                <td>{{ loop.index }}</td>
                                <td>
                                    <strong>{{ student.name }}</strong>
                                    <br>
                                    <small class="text-muted">{{ student.nisn }}</small>
                                </td>
                                <td><code>{{ student.nisn }}</code></td>
                                <td>
                                    <span class="badge" style="background-color: #FEF08A; color: #713F12;">{{ student.kelas }}</span>
                                </td>
                                <td>
                                    <strong>{{ student.parent_name }}</strong>
                                    <br>
                                    <small class="text-muted">{{ student.alamat }}</small>
                                </td>
                                <td>
                                    <a href="tel:{{ student.parent_phone }}" style="color: #6366F1; text-decoration: none;">
                                        <i class="fas fa-phone"></i> {{ student.parent_phone }}
                                    </a>
                                </td>
                                <td>
                                    <a href="{{ url_for('students.detail', student_id=student.id) }}" class="btn btn-sm btn-primary">
                                        <i class="fas fa-plus-circle"></i> Catat Bayar
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <div style="font-size: 3rem; color: #D1D5DB; margin-bottom: 10px;">
                        <i class="fas fa-check-double"></i>
                    </div>
                    <h5 style="color: #6B7280;">Semua Santri Sudah Bayar</h5>
                    <p style="color: #9CA3AF;">Semua santri telah melakukan pembayaran bulan ini. Bagus!</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
    .badge {
        padding: 0.5rem 0.75rem;
        border-radius: 0.375rem;
        font-weight: 500;
        font-size: 0.85rem;
    }

    .table > :not(caption) > * > * {
        padding: 1rem 0.75rem;
    }

    .nav-tabs .nav-link {
        color: #6B7280;
        border: none;
        border-bottom: 3px solid transparent;
        transition: all 0.3s ease;
    }

    .nav-tabs .nav-link:hover {
        color: #6366F1;
    }

    .nav-tabs .nav-link.active {
        color: #6366F1;
        border-bottom-color: #6366F1;
        background-color: transparent;
    }

    .card {
        border: 1px solid #E5E7EB;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .table-hover tbody tr:hover {
        background-color: #F9FAFB;
    }

    .btn-group-sm {
        gap: 4px;
    }

    /* Responsive improvements */
    @media (max-width: 768px) {
        .table {
            font-size: 0.85rem;
        }

        .btn-group-sm {
            display: flex;
            flex-wrap: wrap;
        }

        .btn-group-sm .btn {
            padding: 0.4rem 0.5rem;
            font-size: 0.75rem;
        }

        .row.g-3 {
            gap: 0.75rem;
        }

        .col-md-3 {
            margin-bottom: 0.5rem;
        }
    }

    @media (max-width: 576px) {
        .btn-group {
            flex-direction: column;
            gap: 8px;
        }

        .btn {
            width: 100%;
        }

        .table {
            font-size: 0.75rem;
        }

        th, td {
            padding: 0.5rem !important;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Real-time search dan filter
    document.getElementById('search').addEventListener('keyup', filterTable);
    document.getElementById('filterKelas').addEventListener('change', filterTable);
    document.getElementById('filterStatus').addEventListener('change', filterTable);

    function filterTable() {
        const searchValue = document.getElementById('search').value.toLowerCase();
        const kelasValue = document.getElementById('filterKelas').value;
        const statusValue = document.getElementById('filterStatus').value;
        
        const rows = document.querySelectorAll('.student-row');
        
        rows.forEach(row => {
            const name = row.getAttribute('data-name').toLowerCase();
            const kelas = row.getAttribute('data-kelas');
            const status = row.getAttribute('data-status');
            
            const matchName = name.includes(searchValue);
            const matchKelas = !kelasValue || kelas === kelasValue;
            const matchStatus = !statusValue || status === statusValue;
            
            row.style.display = matchName && matchKelas && matchStatus ? '' : 'none';
        });
    }
</script>
{% endblock %}
