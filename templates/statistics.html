{% extends 'base.html' %} {% block title %}Statistik - PonPay{% endblock %} {%
block page_title %}Statistik Keuangan{% endblock %} {% block content %}
<div class="container-fluid">
  <!-- Filter Period -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <div class="btn-group" role="group">
            <a
              href="{{ url_for('statistics.index', period=1) }}"
              class="btn btn-outline-primary {% if filter_period == '1' %}active{% endif %}"
              >1 Bulan</a
            >
            <a
              href="{{ url_for('statistics.index', period=3) }}"
              class="btn btn-outline-primary {% if filter_period == '3' %}active{% endif %}"
              >3 Bulan</a
            >
            <a
              href="{{ url_for('statistics.index', period=6) }}"
              class="btn btn-outline-primary {% if filter_period == '6' %}active{% endif %}"
              >6 Bulan</a
            >
            <a
              href="{{ url_for('statistics.index', period=12) }}"
              class="btn btn-outline-primary {% if filter_period == '12' %}active{% endif %}"
              >1 Tahun</a
            >
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts Row -->
  <div class="row mb-4">
    <!-- Pengeluaran Chart -->
    <div class="col-lg-6">
      <div class="card card-chart">
        <div class="card-header">
          <h6 class="card-title">Klasifikasi Pengeluaran</h6>
        </div>
        <div class="card-body">
          <div style="position: relative; height: 300px">
            <canvas id="expenseChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Pemasukan Chart -->
    <div class="col-lg-6">
      <div class="card card-chart">
        <div class="card-header">
          <h6 class="card-title">Klasifikasi Pemasukan</h6>
        </div>
        <div class="card-body">
          <div style="position: relative; height: 300px">
            <canvas id="incomeChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Expense vs Income Comparison -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card card-chart">
        <div class="card-header">
          <h6 class="card-title">Perbandingan Pemasukan vs Pengeluaran</h6>
        </div>
        <div class="card-body">
          <div style="position: relative; height: 350px">
            <canvas id="comparisonChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Unpaid Bills per Class -->
  <div class="row">
    <div class="col-12">
      <div class="card card-chart">
        <div class="card-header">
          <h6 class="card-title">Tunggakan Pembayaran per Kelas</h6>
        </div>
        <div class="card-body">
          <div style="position: relative; height: 400px">
            <canvas id="classUnpaidChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  let colors = JSON.parse("{{ colors|safe }}");
  let expenseLabels = JSON.parse("{{ expense_labels|safe }}");
  let expenseValues = JSON.parse("{{ expense_values|safe }}");
  let incomeLabels = JSON.parse("{{ income_labels|safe }}");
  let incomeValues = JSON.parse("{{ income_values|safe }}");
  let classLabels = JSON.parse("{{ class_labels|safe }}");
  let classValues = JSON.parse("{{ class_values|safe }}");

  // Expense Pie Chart
  if (expenseLabels.length > 0) {
    const expenseCtx = document.getElementById("expenseChart").getContext("2d");
    new Chart(expenseCtx, {
      type: "doughnut",
      data: {
        labels: expenseLabels,
        datasets: [
          {
            data: expenseValues,
            backgroundColor: colors,
            borderColor: "#fff",
            borderWidth: 2,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: "bottom",
            labels: {
              usePointStyle: true,
              padding: 15,
              font: { size: 11 },
            },
          },
        },
      },
    });
  }

  // Income Pie Chart
  if (incomeLabels.length > 0) {
    const incomeCtx = document.getElementById("incomeChart").getContext("2d");
    new Chart(incomeCtx, {
      type: "doughnut",
      data: {
        labels: incomeLabels,
        datasets: [
          {
            data: incomeValues,
            backgroundColor: colors,
            borderColor: "#fff",
            borderWidth: 2,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: "bottom",
            labels: {
              usePointStyle: true,
              padding: 15,
              font: { size: 11 },
            },
          },
        },
      },
    });
  }

  // Comparison Bar Chart
  const comparisonCtx = document
    .getElementById("comparisonChart")
    .getContext("2d");
  new Chart(comparisonCtx, {
    type: "bar",
    data: {
      labels: ["Total"],
      datasets: [
        {
          label: "Pemasukan",
          data: [
            incomeValues.length > 0
              ? incomeValues.reduce((a, b) => a + b, 0)
              : 0,
          ],
          backgroundColor: "#2E7D32",
        },
        {
          label: "Pengeluaran",
          data: [
            expenseValues.length > 0
              ? expenseValues.reduce((a, b) => a + b, 0)
              : 0,
          ],
          backgroundColor: "#D32F2F",
        },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      indexAxis: "y",
      plugins: {
        legend: {
          position: "top",
          labels: {
            usePointStyle: true,
            padding: 15,
            font: { size: 12, weight: "bold" },
          },
        },
      },
      scales: {
        x: {
          ticks: {
            callback: function (value) {
              return "Rp " + (value / 1000000).toFixed(1) + "M";
            },
          },
        },
      },
    },
  });

  // Class Unpaid Bar Chart
  const classUnpaidCtx = document
    .getElementById("classUnpaidChart")
    .getContext("2d");
  new Chart(classUnpaidCtx, {
    type: "bar",
    data: {
      labels: classLabels,
      datasets: [
        {
          label: "Total Tunggakan",
          data: classValues,
          backgroundColor: "rgba(211, 47, 47, 0.7)",
          borderColor: "#D32F2F",
          borderWidth: 1,
        },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false,
        },
        tooltip: {
          callbacks: {
            label: function (context) {
              let label = context.dataset.label || "";
              if (label) {
                label += ": ";
              }
              if (context.parsed.y !== null) {
                label += new Intl.NumberFormat("id-ID", {
                  style: "currency",
                  currency: "IDR",
                  maximumFractionDigits: 0,
                }).format(context.parsed.y);
              }
              return label;
            },
          },
        },
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function (value) {
              return "Rp " + (value / 1000).toFixed(0) + "rb";
            },
          },
        },
      },
    },
  });
</script>
{% endblock %}
