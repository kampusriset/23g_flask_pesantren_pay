{% extends "base.html" %}

{% block title %}Import Data Santri - PonPay{% endblock %}

{% block page_title %}
<div class="d-flex justify-content-between align-items-center">
    <div>
        <h1 class="page-title"><i class="fas fa-upload"></i> Import Data Santri</h1>
        <p class="text-muted">Upload file Excel berisi data santri</p>
    </div>
    <div>
        <a href="{{ url_for('students.export_excel') }}" class="btn btn-info me-2">
            <i class="fas fa-download"></i> Download Template
        </a>
        <a href="{{ url_for('students.index') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Kembali
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-8">
            <!-- Upload Form -->
            <div class="card mb-4">
                <div class="card-header" style="background-color: #6366F1; color: white;">
                    <h5 class="mb-0"><i class="fas fa-file-excel"></i> Upload File Excel</h5>
                </div>
                <div class="card-body">
                    {% if error %}
                        <div class="alert alert-danger" role="alert">
                            <i class="fas fa-exclamation-circle"></i>
                            {{ error }}
                        </div>
                    {% endif %}

                    {% if success_message %}
                        <div class="alert alert-success" role="alert">
                            <i class="fas fa-check-circle"></i>
                            {{ success_message }}
                        </div>
                    {% endif %}

                    <form method="POST" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="file" class="form-label">Pilih File Excel</label>
                            <input type="file" class="form-control" id="file" name="file" accept=".xlsx,.xls" required>
                            <small class="text-muted">Format: .xlsx atau .xls</small>
                        </div>

                        <div class="mb-3">
                            <h6><i class="fas fa-info-circle"></i> Format File:</h6>
                            <p class="small">File Excel harus memiliki kolom dalam urutan berikut:</p>
                            <ul class="small">
                                <li>Kolom A: No. (nomor urut)</li>
                                <li>Kolom B: Nama Santri (wajib)</li>
                                <li>Kolom C: NISN</li>
                                <li>Kolom D: Kelas</li>
                                <li>Kolom E: Jenis Kelamin</li>
                                <li>Kolom F: No. HP</li>
                                <li>Kolom G: Nama Orang Tua</li>
                                <li>Kolom H: No. HP Orang Tua</li>
                                <li>Kolom I: Alamat</li>
                                <li>Kolom J: Status (aktif/non-aktif)</li>
                            </ul>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-upload"></i> Upload & Import
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Validation Rules -->
            <div class="card">
                <div class="card-header" style="background-color: #F59E0B; color: white;">
                    <h5 class="mb-0"><i class="fas fa-check-square"></i> Aturan Validasi</h5>
                </div>
                <div class="card-body">
                    <ul>
                        <li><strong>Duplikasi Nama:</strong> Sistem akan menolak santri dengan nama yang sama di kelas yang sama</li>
                        <li><strong>Duplikasi NISN:</strong> Sistem akan menolak jika NISN sudah terdaftar di sistem</li>
                        <li><strong>Nama Santri Wajib:</strong> Setiap baris harus memiliki nama santri</li>
                        <li><strong>Laporan Detail:</strong> Sistem akan menampilkan detail santri yang ditolak beserta alasannya</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Import Results -->
        {% if duplicates or errors %}
        <div class="col-lg-4">
            {% if duplicates %}
            <div class="card mb-3">
                <div class="card-header" style="background-color: #F59E0B; color: white;">
                    <h6 class="mb-0"><i class="fas fa-exclamation-triangle"></i> Santri Duplikasi ({{ duplicates|length }})</h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-sm table-hover mb-0">
                            <tbody>
                                {% for dup in duplicates %}
                                <tr>
                                    <td>
                                        <strong>{{ dup.name }}</strong>
                                        <br>
                                        <small class="text-muted">Kelas: {{ dup.kelas }} | NISN: {{ dup.nisn or '-' }}</small>
                                        <br>
                                        <small class="text-danger">{{ dup.reason }}</small>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}

            {% if errors %}
            <div class="card">
                <div class="card-header" style="background-color: #EF4444; color: white;">
                    <h6 class="mb-0"><i class="fas fa-times-circle"></i> Error ({{ errors|length }})</h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-sm table-hover mb-0">
                            <tbody>
                                {% for error in errors %}
                                <tr>
                                    <td>
                                        <small class="text-danger">{{ error }}</small>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        {% else %}
        <!-- Help Section -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header" style="background-color: #3B82F6; color: white;">
                    <h5 class="mb-0"><i class="fas fa-question-circle"></i> Bantuan</h5>
                </div>
                <div class="card-body">
                    <h6>Langkah-langkah:</h6>
                    <ol>
                        <li>Klik "Download Template" untuk download template Excel</li>
                        <li>Isi data santri pada template</li>
                        <li>Upload file Excel yang sudah diisi</li>
                        <li>Sistem akan melakukan validasi duplikasi</li>
                        <li>Santri yang valid akan ditambahkan ke sistem</li>
                    </ol>

                    <h6 class="mt-3">Tips:</h6>
                    <ul>
                        <li>Pastikan tidak ada baris kosong di tengah data</li>
                        <li>Jangan ubah urutan kolom dalam template</li>
                        <li>Gunakan format yang konsisten (terutama untuk kelas)</li>
                        <li>Periksa kembali data sebelum upload</li>
                    </ul>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
