{% extends "base.html" %} {% block title %}Import Data Santri - PonPay{%
endblock %} {% block page_title %}
<div class="d-flex justify-content-between align-items-center">
  <div>
    <h1 class="page-title"><i class="fas fa-upload"></i> Import Data Santri</h1>
    <p class="text-muted">Upload file Excel berisi data santri</p>
  </div>
  <div>
    <a href="{{ url_for('students.download_template') }}" class="btn btn-info me-2">
      <i class="fas fa-download"></i> Download Template
    </a>
    <a href="{{ url_for('students.index') }}" class="btn btn-secondary">
      <i class="fas fa-arrow-left"></i> Kembali
    </a>
  </div>
</div>
{% endblock %} {% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-lg-8">
      <!-- Upload Form -->
      <div class="card mb-4">
        <div
          class="card-header"
          style="background-color: #6366f1; color: white"
        >
          <h5 class="mb-0">
            <i class="fas fa-file-excel"></i> Upload File Excel
          </h5>
        </div>
        <div class="card-body">
          {% if error %}
          <div class="alert alert-danger" role="alert">
            <i class="fas fa-exclamation-circle"></i>
            {{ error }}
          </div>
          {% endif %} {% if success_message %}
          <div class="alert alert-success" role="alert">
            <i class="fas fa-check-circle"></i>
            {{ success_message }}
          </div>
          {% endif %}

          <form method="POST" enctype="multipart/form-data" id="importForm">
            <div class="mb-3">
              <label class="form-label">Pilih File Excel</label>

              <div
                id="dropZone"
                class="p-4 rounded border d-flex align-items-center justify-content-center flex-column"
                style="border-style: dashed; cursor: pointer"
              >
                <i
                  class="fas fa-cloud-upload-alt fa-2x mb-2 text-secondary"
                ></i>
                <strong id="dropText"
                  >Tarik dan lepas file di sini, atau klik untuk memilih</strong
                >
                <small class="text-muted"
                  >Format yang diperbolehkan: .xlsx, .xls â€” ukuran maksimal
                  5MB</small
                >
                <input
                  type="file"
                  id="file"
                  name="file"
                  accept=".xlsx,.xls"
                  required
                  style="display: none"
                />
                <div id="fileInfo" class="mt-2" style="display: none"></div>
              </div>
              <small class="text-muted d-block mt-2"
                >Gunakan template resmi untuk menghindari kesalahan
                format.</small
              >
            </div>

            <div class="mb-3">
              <h6><i class="fas fa-info-circle"></i> Format File:</h6>
              <p class="small">
                File Excel harus memiliki kolom dalam urutan berikut:
              </p>
              <ul class="small">
                <li>Kolom A: No. (nomor urut)</li>
                <li>Kolom B: Nama Santri (wajib)</li>
                <li>Kolom C: NISN</li>
                <li>Kolom D: Kelas</li>
                <li>Kolom E: Jenis Kelamin</li>
                <li>Kolom F: No. HP</li>
                <li>Kolom G: Nama Orang Tua</li>
                <li>Kolom H: No. HP Orang Tua</li>
                <li>Kolom I: Alamat</li>
                <li>Kolom J: Status (aktif/non-aktif)</li>
              </ul>
            </div>

            <div class="d-grid gap-2">
              <button
                type="submit"
                id="submitBtn"
                class="btn btn-primary btn-lg"
              >
                <i class="fas fa-upload me-2"></i>
                <span id="btnText">Upload & Import</span>
                <span
                  id="btnSpinner"
                  class="spinner-border spinner-border-sm ms-2"
                  role="status"
                  aria-hidden="true"
                  style="display: none"
                ></span>
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Validation Rules -->
      <div class="card">
        <div
          class="card-header"
          style="background-color: #f59e0b; color: white"
        >
          <h5 class="mb-0">
            <i class="fas fa-check-square"></i> Aturan Validasi
          </h5>
        </div>
        <div class="card-body">
          <ul>
            <li>
              <strong>Duplikasi Nama:</strong> Sistem akan menolak santri dengan
              nama yang sama di kelas yang sama
            </li>
            <li>
              <strong>Duplikasi NISN:</strong> Sistem akan menolak jika NISN
              sudah terdaftar di sistem
            </li>
            <li>
              <strong>Nama Santri Wajib:</strong> Setiap baris harus memiliki
              nama santri
            </li>
            <li>
              <strong>Laporan Detail:</strong> Sistem akan menampilkan detail
              santri yang ditolak beserta alasannya
            </li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Import Results -->
    {% if duplicates or errors %}
    <div class="col-lg-4">
      {% if duplicates %}
      <div class="card mb-3">
        <div
          class="card-header"
          style="background-color: #f59e0b; color: white"
        >
          <h6 class="mb-0">
            <i class="fas fa-exclamation-triangle"></i> Santri Duplikasi ({{
            duplicates|length }})
          </h6>
        </div>
        <div class="card-body p-0">
          <div
            class="table-responsive"
            style="max-height: 400px; overflow-y: auto"
          >
            <table class="table table-sm table-hover mb-0">
              <tbody>
                {% for dup in duplicates %}
                <tr>
                  <td>
                    <strong>{{ dup.name }}</strong>
                    <br />
                    <small class="text-muted"
                      >Kelas: {{ dup.kelas }} | NISN: {{ dup.nisn or '-'
                      }}</small
                    >
                    <br />
                    <small class="text-danger">{{ dup.reason }}</small>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      {% endif %} {% if errors %}
      <div class="card">
        <div
          class="card-header"
          style="background-color: #ef4444; color: white"
        >
          <h6 class="mb-0">
            <i class="fas fa-times-circle"></i> Error ({{ errors|length }})
          </h6>
        </div>
        <div class="card-body p-0">
          <div
            class="table-responsive"
            style="max-height: 400px; overflow-y: auto"
          >
            <table class="table table-sm table-hover mb-0">
              <tbody>
                {% for error in errors %}
                <tr>
                  <td>
                    <small class="text-danger">{{ error }}</small>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
    {% else %}
    <!-- Help Section -->
    <div class="col-lg-4">
      <div class="card">
        <div
          class="card-header"
          style="background-color: #3b82f6; color: white"
        >
          <h5 class="mb-0"><i class="fas fa-question-circle"></i> Bantuan</h5>
        </div>
        <div class="card-body">
          <h6>Langkah-langkah:</h6>
          <ol>
            <li>Klik "Download Template" untuk download template Excel</li>
            <li>Isi data santri pada template</li>
            <li>Upload file Excel yang sudah diisi</li>
            <li>Sistem akan melakukan validasi duplikasi</li>
            <li>Santri yang valid akan ditambahkan ke sistem</li>
          </ol>

          <h6 class="mt-3">Tips:</h6>
          <ul>
            <li>Pastikan tidak ada baris kosong di tengah data</li>
            <li>Jangan ubah urutan kolom dalam template</li>
            <li>Gunakan format yang konsisten (terutama untuk kelas)</li>
            <li>Periksa kembali data sebelum upload</li>
          </ul>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  // Drag & drop + file validation for import
  (function () {
    const dropZone = document.getElementById("dropZone");
    const fileInput = document.getElementById("file");
    const fileInfo = document.getElementById("fileInfo");
    const importForm = document.getElementById("importForm");
    const submitBtn = document.getElementById("submitBtn");
    const btnSpinner = document.getElementById("btnSpinner");
    const btnText = document.getElementById("btnText");

    if (!dropZone || !fileInput) return;

    const allowed = [
      "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
      "application/vnd.ms-excel",
    ];

    function showFile(file) {
      fileInfo.style.display = "block";
      fileInfo.innerHTML = `<div class="badge bg-light text-dark p-2">${
        file.name
      } &middot; ${(file.size / 1024 / 1024).toFixed(2)} MB</div>`;
    }

    dropZone.addEventListener("click", () => fileInput.click());

    dropZone.addEventListener("dragover", function (e) {
      e.preventDefault();
      dropZone.style.background = "rgba(0,0,0,0.03)";
    });
    dropZone.addEventListener("dragleave", function (e) {
      dropZone.style.background = "";
    });
    dropZone.addEventListener("drop", function (e) {
      e.preventDefault();
      dropZone.style.background = "";
      const f = e.dataTransfer.files[0];
      if (f) {
        fileInput.files = e.dataTransfer.files;
        validateAndShow(f);
      }
    });

    fileInput.addEventListener("change", function () {
      const f = this.files[0];
      if (f) validateAndShow(f);
    });

    function validateAndShow(f) {
      // size limit 5MB
      if (f.size > 5 * 1024 * 1024) {
        alert("Ukuran file terlalu besar. Maksimal 5MB.");
        fileInput.value = "";
        fileInfo.style.display = "none";
        return;
      }
      // minimal mime check by extension fallback
      const name = f.name.toLowerCase();
      if (!(name.endsWith(".xlsx") || name.endsWith(".xls"))) {
        alert("Format file tidak didukung. Gunakan .xlsx atau .xls");
        fileInput.value = "";
        fileInfo.style.display = "none";
        return;
      }
      showFile(f);
    }

    importForm.addEventListener("submit", function (e) {
      if (!fileInput.files || !fileInput.files.length) {
        e.preventDefault();
        alert("Pilih file Excel terlebih dahulu.");
        return;
      }
      // disable submit to prevent double submit
      submitBtn.disabled = true;
      btnSpinner.style.display = "inline-block";
      btnText.textContent = "Mengunggah...";
    });
  })();
</script>
{% endblock %}
